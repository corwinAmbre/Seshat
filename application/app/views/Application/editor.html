#{extends 'main.html' /}
#{set title:'Editor' /}

<div id="editor" class="flex-container">
	<div id="editor_content" class="flex-item-fluid">
		<div class="chapter" v-for="chapter in chapters" id="chapter_{{chapter.number}}">
			<h3 class="lobster txtcenter w100">Chapter {{chapter.number}}</h3>
			<div contenteditable="true" class="scene" v-for="scene in chapter.content" id="chapter_{{chapter.number}}_scene_{{$index}}" v-on:keyup="contentUpdate(chapter.number, $index, $event)" v-on:blur="contentUpdate(chapter.number, $index, $event)" v-on:paste="contentUpdate(chapter.number, $index, $event)" v-on:delete="contentUpdate(chapter.number, $index, $event)" v-on:focus="contentUpdate(chapter.number, $index, $event)">
				{{{* scene.content}}}
			</div>
		</div>
	</div>
	<nav id="editor_nav" class="w200p">
		<div>
			<i class="material-icons button" title="Save to server" v-on:click="pushToServer()">save</i>
			<i class="material-icons button" title="Add a chapter" v-on:click="addChapter()">add_circle</i>
		</div>
		Chapters
		<ul class="chapter_list">
			<li v-for="chapter in chapters" v-on:click="goTo(chapter.number)" class="chapter_list">
				{{chapter.number}}
			</li>
		</ul>
	</nav>
</div>
<script type="text/javascript">
	var projectEncrypted = "${project.getLatestVersionContent()}";
	var projectKey = "${project.idKey}";
	var vault = readVault();
	var decryptionKey = vault[projectKey];
	var projectJson = JSON.parse(decryptFromServer(decryptionKey.key, decryptionKey.iv, projectEncrypted));
	if(projectJson.remoteId == null) {
		projectJson.remoteId = ${project.id};
	}
	var project = Object.assign(new Project("tmp"), projectJson);
	
	var projectVue = new Vue({
		el: '#editor',
		data: project,
		methods: {
			goTo: function(number) {
				window.location.href= "#chapter_" + number;
			},
			contentUpdate: function(chapter, scene, event) {
				this.chapters[chapter - 1 ].content[scene].content = $(event.target).html().trim();
			},
			pushToServer: function() {
				saveProjectVersion(this.$data);
			},
			addChapter: function() {
				this.$data.addChapter();
			}
		},
		ready: function() {
			if(this.$data.chapters.length == 1 && this.$data.chapters[0].content.length == 1) {
				var node = $("#chapter_1_scene_0").get(0);
				var isNodeEmpty = false;
				if(node.innerHTML.length == 0) {
					node.innerHTML = '\u00a0';
					isNodeEmpty = true;
				}
				var range = document.createRange();
				if(isNodeEmpty) {
					range.selectNodeContents(node);
				} else {
					var lastPos = node.innerHTML.trim().length;
					range.setStart(node, lastPos - 1);
					range.setEnd(node, lastPos - 1);	
				}
				var selection = window.getSelection();
				selection.removeAllRanges();
				selection.addRange(range);
				if(isNodeEmpty) {
					document.execCommand('delete', false, null);
				}
			}
		}
	});
</script>